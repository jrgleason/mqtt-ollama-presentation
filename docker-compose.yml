version: '3.8'

services:
  # Oracle - Main Next.js chatbot application
  oracle:
    build:
      context: ./apps/oracle
      dockerfile: Dockerfile
    container_name: oracle
    ports:
      - "3000:3000"
    environment:
      # Auth0 (required)
      - AUTH0_SECRET=${AUTH0_SECRET}
      - APP_BASE_URL=${APP_BASE_URL:-http://localhost:3000}
      - AUTH0_DOMAIN=${AUTH0_DOMAIN}
      - AUTH0_CLIENT_ID=${AUTH0_CLIENT_ID}
      - AUTH0_CLIENT_SECRET=${AUTH0_CLIENT_SECRET}

      # Database
      - DATABASE_URL=file:./dev.db

      # MQTT
      - MQTT_BROKER_URL=mqtt://mosquitto:1883

      # Ollama
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_MODEL=${OLLAMA_MODEL:-qwen3:1.7b}
    volumes:
      - oracle-data:/app/prisma
    depends_on:
      - mosquitto
    networks:
      - home-automation
    restart: unless-stopped

  # Voice Gateway OWW - Voice command service (optional, Phase 5)
  voice-gateway-oww:
    build:
      context: ./apps/voice-gateway-oww
      dockerfile: Dockerfile
    container_name: voice-gateway-oww
    devices:
      - /dev/snd:/dev/snd  # ALSA audio devices
    environment:
      # OpenWakeWord
      - OWW_MODEL_PATH=models/hey_jarvis_v0.1.onnx
      - OWW_THRESHOLD=0.5

      # Audio
      - MIC_DEVICE=plughw:2,0
      - SPEAKER_DEVICE=plughw:2,0
      - SAMPLE_RATE=16000

      # VAD
      - SILENCE_THRESHOLD=0.001
      - SILENCE_DURATION_MS=1000

      # Ollama Whisper
      - OLLAMA_BASE_URL=http://host.docker.internal:11434
      - OLLAMA_WHISPER_MODEL=whisper:latest

      # Piper TTS
      - TTS_ENABLED=true
      - TTS_MODEL_PATH=models/piper/en_US-amy-medium.onnx
      - TTS_VOLUME=1.0
      - TTS_SPEED=1.0

      # MQTT
      - MQTT_BROKER_URL=mqtt://mosquitto:1883
      - MQTT_CLIENT_ID=voice-gateway-oww
    volumes:
      - voice-models:/app/models
    depends_on:
      - mosquitto
    networks:
      - home-automation
    restart: unless-stopped
    # Optional: Comment out if not using voice features
    profiles:
      - voice

  # Z-Wave JS UI - Z-Wave device management
  zwave-js-ui:
    image: zwavejs/zwave-js-ui:latest
    container_name: zwave-js-ui
    devices:
      - /dev/ttyACM0:/dev/ttyACM0  # Z-Wave USB stick (adjust if different)
    environment:
      - TZ=America/New_York
    ports:
      - "8091:8091"  # Web UI
      - "3000:3000"  # WebSocket
    volumes:
      - zwave-data:/usr/src/app/store
    networks:
      - home-automation
    restart: unless-stopped

  # Eclipse Mosquitto - MQTT Broker
  # Local MQTT broker for development and production
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"  # MQTT
      - "9001:9001"  # WebSocket
    volumes:
      - ./deployment/mosquitto/config:/mosquitto/config
      - mosquitto-data:/mosquitto/data
      - mosquitto-log:/mosquitto/log
    networks:
      - home-automation
    restart: unless-stopped

volumes:
  oracle-data:
    driver: local
  voice-models:
    driver: local
  zwave-data:
    driver: local
  mosquitto-data:
    driver: local
  mosquitto-log:
    driver: local

networks:
  home-automation:
    driver: bridge
