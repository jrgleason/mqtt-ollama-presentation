# Nginx site configuration for Oracle (Next.js app)
# This proxies HTTP requests from port 80 to the Next.js app running on port 3000
#
# Installation:
# 1. Copy this file to /etc/nginx/sites-available/oracle
# 2. Create symlink: sudo ln -s /etc/nginx/sites-available/oracle /etc/nginx/sites-enabled/
# 3. Remove default site: sudo rm /etc/nginx/sites-enabled/default
# 4. Test config: sudo nginx -t
# 5. Reload nginx: sudo systemctl reload nginx

server {
    listen 80 default_server;
    listen [::]:80 default_server;

    server_name _;

    # Proxy requests to Next.js app on port 3000
    location / {
        proxy_pass http://localhost:3000;
        proxy_http_version 1.1;

        # WebSocket support (for Next.js dev mode hot reload)
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';

        # Standard proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # Disable caching for Next.js (it handles caching internally)
        proxy_cache_bypass $http_upgrade;

        # Timeouts for SSE streaming (chat responses)
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }

    # Static assets (optional - Next.js serves these, but nginx can cache them)
    location /_next/static {
        proxy_pass http://localhost:3000;
        proxy_cache_valid 200 60m;
        proxy_cache_bypass $http_cache_control;
        add_header Cache-Control "public, max-age=3600, immutable";
    }

    # Health check endpoint (optional)
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
}
