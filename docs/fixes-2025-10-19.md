# Bug Fixes - October 19, 2025

## Summary

Fixed three code quality and API issues across multiple modules, added comprehensive tests, and improved documentation.

---

## 1. MQTT Client Options Preservation Fix

**Module:** `apps/oracle/src/lib/mqtt/client.js`

**Issue:** The `publish()` method was only forwarding the `qos` option and dropping all other valid mqtt.js options like
`retain`, `dup`, and `properties`.

**Impact:**

- Users couldn't set retain flags for device state persistence
- MQTT 5.0 properties were being silently dropped
- Lost advanced mqtt.js functionality

**Fix:**

```javascript
// Before (line 120)
this.client.publish(topic, payload, {qos: options.qos || 0}, callback);

// After
this.client.publish(topic, payload, { qos: 0, ...options }, callback);
```

**Benefits:**

- ✅ Preserves all caller-provided options
- ✅ Maintains backward compatibility
- ✅ Enables MQTT 5.0 features
- ✅ Follows mqtt.js API contract

**Testing:** Added 13 comprehensive unit tests in `src/lib/mqtt/__tests__/client.test.js`

**Documentation:** Created complete API documentation in `apps/oracle/docs/MQTT_CLIENT_API.md`

---

## 2. ESLint Regex Fix

**Module:** `apps/voice-gateway-oww/src/markdown-to-speech.js`

**Issue:** Unnecessary escape characters in regex character class causing ESLint error.

**Fix:**

```javascript
// Before (line 32)
code.replace(/[{}()\[\];]/g, ...)

// After
code.replace(/[{}()[\];]/g, ...)
```

**Impact:** ESLint now passes cleanly without warnings.

---

## 3. MCP Client Defensive Programming

**Module:** `apps/zwave-mcp-server/src/mcp-client.js`

**Issue:** The `sendRequest()` method assumed callers would always set `message.id` and `message.jsonrpc`. If omitted,
timeout handlers and pending request matching would fail.

**Fix:**

```javascript
// Added (lines 174-179)
if (message.id == null) {
  message.id = this.messageId++;
}
if (!message.jsonrpc) {
  message.jsonrpc = '2.0';
}
```

**Benefits:**

- ✅ Auto-assigns incrementing IDs if missing
- ✅ Ensures JSON-RPC 2.0 compliance
- ✅ Prevents timeout/matching failures
- ✅ More forgiving API

---

## 4. Test Infrastructure Improvements

**Module:** `apps/oracle`

**Changes:**

- Configured Jest for ES modules support
- Added `NODE_OPTIONS=--experimental-vm-modules` to test scripts
- Updated `jest.config.mjs` for ES module compatibility

**Test Coverage:**

```
Test Suites: 2 passed, 2 total
Tests:       16 passed, 16 total
```

---

## 5. Debug Logging Cleanup (GitHub PR #6 Review)

**Modules:** `apps/oracle/src/lib/langchain/tools/*`, `apps/oracle/src/app/api/chat/route.js`

**Issue:** Multiple console.log statements were not gated behind DEBUG flags, causing verbose logging in production.

**Fix:**

Added DEBUG flag checks to all debug logging:

```javascript
const DEBUG = process.env.LOG_LEVEL === 'debug' || process.env.NODE_ENV === 'development';

// All debug logs now gated
if (DEBUG) {
    console.log('[tool] Debug information...');
}
```

**Files Fixed:**

1. **`apps/oracle/src/lib/langchain/tools/device-control-tool.js`**
   - Lines 27, 56, 74, 84, 93: Gated 5 console.log statements

2. **`apps/oracle/src/lib/langchain/tools/device-list-tool.js`**
   - Lines 17, 28: Gated 2 console.log statements

3. **`apps/oracle/src/app/api/chat/route.js`**
   - Lines 168-171, 213: Gated 5 console.log statements

**Benefits:**

- ✅ Clean production logs (no debug noise)
- ✅ Debug logging available in development
- ✅ Consistent with existing DEBUG pattern in codebase
- ✅ Better performance (no unnecessary logging overhead)

---

## 6. Voice Gateway Setup Script Improvements

**Module:** `apps/voice-gateway-oww/setup.sh`

**Issue:** Setup script was missing OpenWakeWord model downloads and hardcoding wrong Ollama model.

**Fixes:**

### 6.1 Added OpenWakeWord Model Downloads (Step 5)

```bash
# Core models (required)
- melspectrogram.onnx
- embedding_model.onnx

# Wake word models
- hey_jarvis_v0.1.onnx
```

Downloads from: `https://github.com/dscripka/openWakeWord/releases/download/v0.5.1`

### 6.2 Fixed Ollama Model Detection (Step 6)

**Before:** Hardcoded `Qwen3:1.7b`

**After:** Reads from `.env` file, defaults to `qwen2.5:0.5b`

```bash
OLLAMA_MODEL="qwen2.5:0.5b"
if [[ -f .env ]]; then
    ENV_MODEL=$(grep "^OLLAMA_MODEL=" .env | cut -d'=' -f2 | tr -d '"' | xargs)
    if [[ -n "$ENV_MODEL" ]]; then
        OLLAMA_MODEL="$ENV_MODEL"
    fi
fi
```

**Documentation Updates:**

- Updated `apps/voice-gateway-oww/README.md` to use `./setup.sh`
- Updated `apps/voice-gateway-oww/package.json` setup script to call `bash setup.sh`

---

## Documentation Updates

### New Files Created:

1. **`apps/oracle/docs/MQTT_CLIENT_API.md`** (570+ lines)
    - Complete API reference
    - Usage examples
    - Best practices
    - Troubleshooting guide
    - Migration guide

2. **`apps/oracle/src/lib/mqtt/__tests__/client.test.js`** (330+ lines)
    - 13 comprehensive test cases
    - Edge case coverage
    - Real-world scenario testing

### Updated Files:

1. **`apps/oracle/README.md`**
    - Added link to MQTT Client API documentation
    - Added API Documentation section

2. **`apps/oracle/package.json`**
    - Updated test scripts to support ES modules

3. **`apps/oracle/jest.config.mjs`**
    - Removed invalid `extensionsToTreatAsEsm` config

---

## Impact Assessment

### High Impact

- **MQTT Client Fix**: Critical for any code using MQTT options beyond basic QoS
    - Affects device state persistence (retain flag)
    - Affects MQTT 5.0 adoption
    - Affects reliability (QoS levels)

### Medium Impact

- **MCP Client Fix**: Improves developer experience and prevents potential runtime errors
- **Test Infrastructure**: Enables better code quality and confidence

### Low Impact

- **ESLint Fix**: Code quality improvement, no functional changes

---

## Testing Done

### Automated Tests

```bash
✓ npm test (all tests pass)
✓ npm run lint (no warnings)
✓ 13 new MQTT client tests (all passing)
```

### Manual Testing

- Verified MQTT client preserves all options
- Confirmed backward compatibility with existing code
- Tested auto-connection behavior

---

## Breaking Changes

**None.** All changes are backward compatible.

Existing code that only uses `qos` option will continue to work exactly as before. New code can now use additional
options.

---

## Migration Required

**None.** These are pure improvements that don't require any code changes.

However, developers should be aware that they can now use:

- `retain` flag for persistent device state
- `qos` levels 1 and 2 for reliable delivery
- MQTT 5.0 `properties` for advanced features

---

## Recommendations

1. **Update device control code** to use `retain: true` for state messages
2. **Use QoS 1** for critical commands (alarms, locks, etc.)
3. **Review MQTT Client API docs** for additional features
4. **Consider MQTT 5.0 properties** for advanced use cases

---

## Files Changed

### Bug Fixes

1. `apps/oracle/src/lib/mqtt/client.js` - MQTT options fix
2. `apps/voice-gateway-oww/src/markdown-to-speech.js` - ESLint fix
3. `apps/zwave-mcp-server/src/mcp-client.js` - Defensive programming

### Test Infrastructure

4. `apps/oracle/jest.config.mjs` - ES modules support
5. `apps/oracle/package.json` - Test script updates

### Debug Logging Cleanup

6. `apps/oracle/src/lib/langchain/tools/device-control-tool.js` - Gated debug logs
7. `apps/oracle/src/lib/langchain/tools/device-list-tool.js` - Gated debug logs
8. `apps/oracle/src/app/api/chat/route.js` - Gated debug logs

### Setup Script Improvements

9. `apps/voice-gateway-oww/setup.sh` - Added OpenWakeWord downloads, fixed Ollama model detection
10. `apps/voice-gateway-oww/package.json` - Updated setup command
11. `apps/voice-gateway-oww/README.md` - Updated setup instructions

### Documentation

12. `apps/oracle/README.md` - Documentation links
13. `apps/oracle/docs/MQTT_CLIENT_API.md` - API documentation (NEW)
14. `apps/oracle/src/lib/mqtt/__tests__/client.test.js` - Unit tests (NEW)
15. `docs/fixes-2025-10-19.md` - This file (NEW)

---

## References

- [mqtt.js API Documentation][mqttjs-api]
- [MQTT 5.0 Specification][mqtt5-spec]
- [Jest ES Modules Support][jest-esm]
- [JSON-RPC 2.0 Specification][jsonrpc-spec]

---

**Reviewed by:** Claude Code
**Date:** October 19, 2025
**Status:** ✅ Complete and Tested

---

<!-- Reference Links -->
[mqttjs-api]: https://github.com/mqttjs/MQTT.js#api
[mqtt5-spec]: https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html
[jest-esm]: https://jestjs.io/docs/ecmascript-modules
[jsonrpc-spec]: https://www.jsonrpc.org/specification
